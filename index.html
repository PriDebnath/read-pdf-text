<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>PDF Reader with Highlighting</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        .word {
            padding: 2px 4px;
            display: inline-block;
        }

        .highlight {
            background-color: yellow;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h2>PDF Reader</h2>
    <input type="file"
           id="fileInput"
           accept="application/pdf"><br><br>
    <button id="startBtn">Read</button>
    <button id="pauseBtn">Pause</button>
    <button id="stopBtn">Stop</button>
    <button id="resumeBtn">Resume</button>
    <select id="speedSelect">
        <option value="200">Normal Speed</option>
        <option value="100">Fast Speed</option>
        <option selected
                value="50"> Super Fast Speed</option>
        <option value="300">Slow Speed</option>
    </select>

    <div id="pdfText"
         style="margin-top:20px;"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>
        const fileInput = document.getElementById('fileInput');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const resumeBtn = document.getElementById('resumeBtn');
        const pdfTextDiv = document.getElementById('pdfText');
        const speedSelect = document.getElementById('speedSelect');
        ////

        let words = [];
        let currentIndex = 0;
        let isPaused = false;
        let isStopped = false;
        let isReading = false;
        // let readingSpeed = 200;
        let pausedIndex = -1; // To track where we left off during pause
        let utterance;

        ////

        const handleReadingSpeedChange = (event) => {
            readingSpeed = parseInt(event.target.value);
            console.log("Reading speed set to:", readingSpeed);
        };

        const getReadingSpeed = () => {
            const selectedSpeed = Number(speedSelect.value);

            return selectedSpeed;
        }
        speedSelect.addEventListener('change', handleReadingSpeedChange);

        const displayWords = (text) => {
            words = text.trim().split(/\s+/);
            pdfTextDiv.innerHTML = '';
            words.forEach((word, i) => {
                const span = document.createElement('span');
                span.className = 'word';
                span.id = `word-${i}`;
                span.textContent = word + ' ';
                pdfTextDiv.appendChild(span);
            });
            currentIndex = 0; // Reset to start when a new PDF is loaded
            pausedIndex = -1; // Reset the paused index
        }

        const removeHighlights = () => {
            document.querySelectorAll('.word').forEach(el => el.classList.remove('highlight'));
        }

        const highlightWord = (index) => {
            removeHighlights()
            const el = document.getElementById(`word-${index}`);
            if (el) {
                el.classList.add('highlight');
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        const handleFileInputChange = async () => {
            const file = fileInput.files[0];
            if (!file || file.type !== 'application/pdf') return;

            const reader = new FileReader();
            reader.readAsArrayBuffer(file);

            reader.onload = async function () {
                let text = '';

                const typedarray = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    let texts = content.items
                    let textsString = texts.map(item => item.str)

                    let formattedText = textsString.join(' ') + ' ';
                    console.log({
                        content,
                        texts,
                        textsString,
                        formattedText
                    })

                    text = text + formattedText
                }
                displayWords(text);
            };
        }


        fileInput.addEventListener('change', handleFileInputChange)


        const speakWords = () => {
            if (currentIndex >= words.length || isStopped) {
                console.log("Reading finished or stopped.");
                return;
            }

            const word = words[currentIndex];
            utterance = new SpeechSynthesisUtterance(word);
            utterance.lang = 'en-US';

            utterance.onstart = () => {
                highlightWord(currentIndex);
                console.log(`Speaking word ${currentIndex}: ${word}`);
            };

            utterance.onend = () => {
                if (!isPaused && !isStopped) {
                    currentIndex++;
                    setTimeout(() => {
                        if (!isPaused && !isStopped) {
                            speakWords(); // Continue reading next word
                        }
                    }, 7);
                }
            };

            speechSynthesis.speak(utterance);
        }


        startBtn.onclick = () => {
            if (isReading) return; // Avoid starting multiple readings
            isReading = true;
            isPaused = false;
            isStopped = false;
            speechSynthesis.cancel(); // Reset the speech
            currentIndex = 0;
            speakWords(); // Start reading from the beginning
        };

        pauseBtn.onclick = () => {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel(); // Stop current speaking
                isPaused = true;
                isReading = false; // Pause reading
                pausedIndex = currentIndex; // Save the current word index
                console.log("Paused at word:", currentIndex);
            }
        };

        stopBtn.onclick = () => {
            speechSynthesis.cancel();
            isStopped = true;
            isReading = false;
            currentIndex = 0;

            removeHighlights()

            console.log("Stopped");
        };

        resumeBtn.onclick = () => {
            if (!isPaused) return; // Only resume if paused
            console.log("Resuming from word:", pausedIndex);

            // Clear the current highlight and reapply it for the paused index
            removeHighlights()

            // Re-start the speech synthesis from the paused index
            currentIndex = pausedIndex;
            const wordToRead = words[currentIndex];
            utterance = new SpeechSynthesisUtterance(wordToRead);
            utterance.lang = 'en-US';

            utterance.onstart = () => {
                highlightWord(currentIndex);
                console.log(`Resumed reading from word ${currentIndex}: ${words[currentIndex]}`);
            };

            utterance.onend = () => {
                if (!isStopped) {
                    currentIndex++; // Ensure that currentIndex moves forward after reading the resumed word
                    if (currentIndex < words.length) {
                        setTimeout(() => {
                            if (!isStopped) {
                                speakWords(); // Continue reading the rest
                            }
                        }, 8);
                    }
                }
            };

            speechSynthesis.speak(utterance);
            isPaused = false; // Allow reading to continue after resume
        };



        ////
        pdfTextDiv.addEventListener("click", (event) => {
            const target = event.target;
            if (target.classList.contains("word")) {
                const index = parseInt(target.id.split("-")[1]);
                //

                currentIndex = index;
                const wordToRead = words[currentIndex];
                utterance = new SpeechSynthesisUtterance(wordToRead);
                utterance.lang = 'en-US';


                ////
                // currentIndex = index;
                console.log("Clicked word, starting from index:", currentIndex);
                isPaused = false;
                isReading = true;
                speechSynthesis.cancel();
                // speakFromIndex(currentIndex);
                speakWords();
            }
        });
    </script>
</body>

</html>